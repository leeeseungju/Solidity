<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Rental Platform DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { margin: 4px; padding: 5px; }
    h3 { margin-top: 20px; }
    pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Rental DApp Interface</h1>

  <button onclick="registerUser()">계정 등록</button>
  <button onclick="switchAccount()">계정 전환</button>

  <h3>내가 대여한 상품 보기</h3>
  <button onclick="listMyRentals()">내 대여 목록</button>
  <pre id="myRentalList"></pre>

  <h3>제품 등록</h3>
  <input id="category" placeholder="제품 카테고리">
  <input id="description" placeholder="상세 설명">
  <input id="dailyPrice" placeholder="일일 요금">
  <input id="deposit" placeholder="보증금">
  <input id="imageHash" placeholder="Image IPFS Hash">
  <button onclick="registerAsset()">제품 등록</button>

  <h3>등록된 제품 보기</h3>
  <button onclick="listAssets()">전체 제품 목록 보기</button>
  <pre id="assetList"></pre>

  <h3>제품 삭제</h3>
  <input id="deleteAssetId" placeholder="삭제할 자산 ID">
  <button onclick="deleteAsset()">제품 삭제</button>

  <h3>대여 계약 생성</h3>
  <input id="rentalAssetId" placeholder="자산 ID">
  <input id="startDateInput" placeholder="시작 날짜 (YYYY-MM-DD)">
  <input id="endDateInput" placeholder="종료 날짜 (YYYY-MM-DD)">
  <input id="rentalDeposit" placeholder="보증금 (ETH)">
  <button onclick="createRentalContract()">대여하기</button>

  <h3>대여 완료</h3>
  <input id="completeContractId" placeholder="계약 ID">
  <button onclick="completeRental()">대여 완료</button>

  <h3>후기 작성</h3>
  <input id="reviewContractId" placeholder="계약 ID">
  <input id="reviewee" placeholder="상대 지갑 주소">
  <input id="score" placeholder="점수 (1~5)">
  <input id="comment" placeholder="후기 내용">
  <input id="assetConditionHash" placeholder="자산 상태 해시">
  <button onclick="leaveReview()">후기 남기기</button>

  <h3>후기 확인</h3>
  <input id="reviewLookupId" placeholder="계약 ID">
  <button onclick="loadReviews()">리뷰 조회</button>
  <pre id="reviewResults"></pre>

  <script>
    const contractAddress = "0x659466ff5762821135d0568537A9A114B30c9217";
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "contractId",
				"type": "uint256"
			}
		],
		"name": "completeRental",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "assetId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "startDate",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "endDate",
				"type": "uint256"
			}
		],
		"name": "createRentalContract",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "assetId",
				"type": "uint256"
			}
		],
		"name": "deleteAsset",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "contractId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "reviewee",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "score",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "assetConditionHash",
				"type": "string"
			}
		],
		"name": "leaveReview",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "category",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "dailyPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deposit",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "imageHash",
				"type": "string"
			}
		],
		"name": "registerAsset",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "registerUser",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "admin",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "assetCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "assets",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "category",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "dailyPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deposit",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isAvailable",
				"type": "bool"
			},
			{
				"internalType": "string",
				"name": "imageHash",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "contractCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "rentalContracts",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "assetId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "lender",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "renter",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "startDate",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "endDate",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deposit",
				"type": "uint256"
			},
			{
				"internalType": "enum RentalPlatform.RentalStatus",
				"name": "status",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "reviewsByContract",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "contractId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "reviewer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "reviewee",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "score",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "assetConditionHash",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "userProfiles",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "trustScore",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "totalDeals",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "averageRating",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isRegistered",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]

    let web3;
    let contract;
    let currentAccount;

    window.addEventListener("load", async () => {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: "eth_requestAccounts" });
        const accounts = await web3.eth.getAccounts();
        currentAccount = accounts[0];
        contract = new web3.eth.Contract(contractABI, contractAddress);
      } else {
        alert("MetaMask가 필요합니다.");
      }
    });

    async function switchAccount() {
      const accounts = await web3.eth.getAccounts();
      currentAccount = accounts[0];
      alert("현재 계정 전환됨: " + currentAccount);
    }

    async function registerUser() {
      await contract.methods.registerUser().send({ from: currentAccount });
      alert("회원 등록 완료");
    }

    async function registerAsset() {
      const depositEth = deposit.value;
      const depositWei = web3.utils.toWei(depositEth, "ether");

      const dailyPriceEth = dailyPrice.value;
      const dailyPriceWei = web3.utils.toWei(dailyPriceEth, "ether");

      await contract.methods.registerAsset(
        category.value,
        description.value,
        dailyPriceWei,
        depositWei,
        imageHash.value
      ).send({ from: currentAccount });

      alert("제품 등록 완료");
    }

    async function listMyRentals() {
      try {
        const total = await contract.methods.contractCount().call();
        let result = `총 계약 수: ${total}\n\n`;

        for (let i = 1; i <= total; i++) {
          const rc = await contract.methods.rentalContracts(i).call();
          if (rc.renter.toLowerCase() === currentAccount.toLowerCase()) {
            const asset = await contract.methods.assets(rc.assetId).call();

            const start = new Date(rc.startDate * 1000).toLocaleDateString();
            const end = new Date(rc.endDate * 1000).toLocaleDateString();
            const dailyPriceEth = web3.utils.fromWei(asset.dailyPrice.toString(), "ether");
            // const depositEth = web3.utils.fromWei(asset.deposit.toString(), "ether");
            const depositEth = asset.deposit; 

            result += `
            계약 ID: ${rc.id}
            상품 ID: ${asset.id}
            카테고리: ${asset.category}
            설명: ${asset.description}
            기간: ${start} ~ ${end}
            보증금: ${depositEth} ETH
            대여 가능 여부: ${asset.isAvailable ? '가능' : '불가능'}
            등록자 지갑: ${asset.owner}
            ---------------------------
            `;
          }
        }

        if (result === `총 계약 수: ${total}\n\n`) {
          result = "내가 대여한 상품이 없습니다.";
        }

        document.getElementById("myRentalList").textContent = result;
      } catch (err) {
        console.error(err);
        alert("대여 목록 조회 중 오류 발생");
      }
    }

    async function listAssets() {
      const count = await contract.methods.assetCount().call();
      let result = "총 등록 자산 수: " + count + "\n\n";
      for (let i = 1; i <= count; i++) {
        const asset = await contract.methods.assets(i).call();
        const dailyPriceEth = web3.utils.fromWei(asset.dailyPrice, "ether");
        const depositEth = web3.utils.fromWei(asset.deposit, "ether");

        result += `제품 ID: ${asset.id}
    카테고리: ${asset.category}
    설명: ${asset.description}
    일일 요금: ${dailyPriceEth} ETH
    보증금: ${depositEth} ETH
    대여 가능 여부: ${asset.isAvailable ? '가능' : '불가능'}
    등록자 지갑: ${asset.owner}
    ---------------------------\n`;
      }
      assetList.textContent = result;
    }


    function toTimestamp(dateStr) {
      const date = new Date(dateStr + "T00:00:00Z"); // UTC 기준으로 고정
      return Math.floor(date.getTime() / 1000);
    }

    async function createRentalContract() {
      try {
        const value = web3.utils.toWei(rentalDeposit.value, "ether");
        const start = toTimestamp(document.getElementById("startDateInput").value);
        const end = toTimestamp(document.getElementById("endDateInput").value);

        console.log("요청값:", {
          assetId: rentalAssetId.value,
          startDate: start,
          endDate: end,
          deposit: value,
          from: currentAccount,
        });

        await contract.methods.createRentalContract(
          rentalAssetId.value, start, end
        ).send({ from: currentAccount, value });

        alert("대여 요청 완료");
      } catch (error) {
        console.error("실패: ", error);
        if (error && error.message) {
          alert("실패 원인:\n" + error.message);
        } else {
          alert("알 수 없는 실패");
        }
      }
    }

    async function deleteAsset() {
      const id = document.getElementById("deleteAssetId").value;
      try {
        await contract.methods.deleteAsset(id).send({ from: currentAccount });
        alert("제품이 삭제되었습니다.");
      } catch (err) {
        console.error("삭제 실패:", err);
        alert("삭제 실패: " + err.message);
      }
    }



    async function completeRental() {
      try {
        const contractId = completeContractId.value;
        const rc = await contract.methods.rentalContracts(contractId).call();
        console.log("계약 상태:", rc.status);
        console.log("렌더 주소:", rc.lender);
        console.log("내 주소:", currentAccount);

        await contract.methods.completeRental(contractId).send({ from: currentAccount });
        alert("대여 완료 처리됨");
      } catch (error) {
        console.error("대여 완료 실패:", error);
        alert("대여 완료 실패:\n" + error.message);
      }
    }


    async function leaveReview() {
      await contract.methods.leaveReview(
        reviewContractId.value, reviewee.value,
        score.value, comment.value, assetConditionHash.value
      ).send({ from: currentAccount });
      alert("후기 작성 완료");
    }

    async function loadReviews() {
      const contractId = reviewLookupId.value;
      try {
        const review = await contract.methods.reviewsByContract(contractId, 0).call();
        reviewResults.textContent = JSON.stringify(review, null, 2);
      } catch (e) {
        reviewResults.textContent = "리뷰 없음 또는 오류: " + e.message;
      }
    }
  </script>
</body>
</html>
