<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rental Platform DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --background-color: #f5f6fa;
            --card-background: #ffffff;
            --text-color: #2c3e50;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            background: linear-gradient(135deg, var(--card-background) 0%, #f8f9fa 100%);
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.8em;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .section {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            text-align: center;
            overflow: hidden;
            box-sizing: border-box;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 12px;
            text-align: center;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            min-width: 150px;
            font-size: 1em;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:hover {
            background-color: #357abd;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button.danger {
            background-color: var(--danger-color);
        }

        button.danger:hover {
            background-color: #c0392b;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 1em;
            transition: var(--transition);
            text-align: center;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        pre {
            width: 100%;
            max-width: 100%;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            margin-top: 15px;
            text-align: left;
            border: 1px solid #e0e0e0;
            max-height: 350px;
            font-size: 0.97em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }

            button {
                width: 100%;
                max-width: 300px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2.2em;
            }
        }

        .status-message {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            background-color: #e8f5e9;
            color: #2e7d32;
            text-align: center;
            font-weight: 500;
        }

        .error-message {
            background-color: #ffebee;
            color: #c62828;
            text-align: center;
            font-weight: 500;
        }

        /* ì…ë ¥ í•„ë“œ ê·¸ë£¹ ìŠ¤íƒ€ì¼ë§ */
        .input-group {
            margin-bottom: 20px;
            text-align: center;
        }

        /* ì„¹ì…˜ ë‚´ë¶€ ì»¨í…ì¸  ì •ë ¬ */
        .section-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .row {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            margin-bottom: 30px;
        }
        .row-2col {
            display: flex;
            flex-direction: row;
            gap: 30px;
            justify-content: center;
            align-items: flex-start;
        }
        .row-2col > .section {
            flex: 1 1 0;
            min-width: 320px;
            max-width: 500px;
        }
        @media (max-width: 1100px) {
            .row-2col {
                flex-direction: column;
                gap: 20px;
            }
        }
        .row-3col {
            display: flex;
            flex-direction: row;
            gap: 30px;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
        }
        .row-3col > .section {
            flex: 1 1 0;
            min-width: 0;
            max-width: 100%;
        }
        @media (max-width: 900px) {
            .row-3col {
                flex-direction: column;
                gap: 20px;
            }
        }
        .row:not(.row-2col) > .section {
            width: 98%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-menu {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }
        .tab-btn {
            background: #eaf1fb;
            color: #357abd;
            border: none;
            padding: 12px 24px;
            border-radius: 8px 8px 0 0;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .tab-btn.active, .tab-btn:hover {
            background: #4a90e2;
            color: #fff;
        }
        .tab-content {
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .card-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 18px 22px;
            min-width: 260px;
            max-width: 320px;
            flex: 1 1 260px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid #e0e0e0;
            position: relative;
        }
        .card .card-title {
            font-weight: 700;
            color: #357abd;
            font-size: 1.1em;
            margin-bottom: 4px;
        }
        .card .card-category {
            font-size: 0.98em;
            color: #888;
        }
        .card .card-desc {
            font-size: 1em;
            margin-bottom: 4px;
        }
        .card .card-price {
            color: #4a90e2;
            font-weight: 600;
            font-size: 1em;
        }
        .card .card-owner {
            font-size: 0.92em;
            color: #aaa;
            word-break: break-all;
            white-space: normal;         /* ì¤„ë°”ê¿ˆ í—ˆìš© */
            overflow-wrap: break-word;
        }
        .card .card-available {
            font-size: 0.95em;
            font-weight: 600;
            color: #2ecc71;
        }
        .card .card-unavailable {
            font-size: 0.95em;
            font-weight: 600;
            color: #e74c3c;
        }
        .card .card-id {
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 0.9em;
            color: #bbb;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DApp ëŒ€ì—¬ í”Œë«í¼</h1>
            <div class="button-group">
                <button onclick="registerUser()">ê³„ì • ë“±ë¡</button>
                <button onclick="switchAccount()">ê³„ì • ì „í™˜</button>
            </div>
            <div id="currentAccountDisplay" style="margin-top:10px;font-size:1.1em;color:#357abd;font-weight:500;"></div>
        </header>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tab-menu">
            <button class="tab-btn active" onclick="showTab('tab-products')">ë“±ë¡ëœ ì œí’ˆ</button>
            <button class="tab-btn" onclick="showTab('tab-asset-manage')">ìƒí’ˆ ë“±ë¡/ì‚­ì œ</button>
            <button class="tab-btn" onclick="showTab('tab-my-rentals')">ëŒ€ì—¬í•œ ì œí’ˆ</button>
            <button class="tab-btn" onclick="showTab('tab-complete')">ëŒ€ì—¬ ì™„ë£Œ</button>
            <button class="tab-btn" onclick="showTab('tab-review')">í›„ê¸° ì‘ì„±/í™•ì¸</button>
        </div>

        <!-- ë“±ë¡ëœ ì œí’ˆ íƒ­ -->
        <div class="tab-content" id="tab-products">
            <div class="row">
                <div class="section">
                    <h3>ë“±ë¡ëœ ì œí’ˆ</h3>
                    <div class="section-content">
                        <div class="button-container">
                            <button onclick="listAssets()">ì „ì²´ ì œí’ˆ ëª©ë¡ ë³´ê¸°</button>
                        </div>
                        <div class="card-list" id="assetList"></div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="section">
                    <h3>ëŒ€ì—¬í•˜ê¸°</h3>
                    <div class="section-content">
                        <div class="input-group">
                            <input id="rentalAssetId" placeholder="ìƒí’ˆ ë²ˆí˜¸">
                            <input id="startDateInput" placeholder="ì‹œì‘ ë‚ ì§œ (YYYY-MM-DD)">
                            <input id="endDateInput" placeholder="ì¢…ë£Œ ë‚ ì§œ (YYYY-MM-DD)">
                            <input id="rentalDeposit" placeholder="ë³´ì¦ê¸ˆ (ETH)">
                        </div>
                        <div class="button-container">
                            <button onclick="createRentalContract()">ëŒ€ì—¬í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìƒí’ˆ ë“±ë¡/ì‚­ì œ íƒ­ -->
        <div class="tab-content" id="tab-asset-manage" style="display:none;">
            <div class="row row-2col">
                <div class="section">
                    <h3>ì œí’ˆ ë“±ë¡</h3>
                    <div class="section-content">
                        <div class="input-group">
                            <input id="category" placeholder="ì œí’ˆ ì¹´í…Œê³ ë¦¬">
                            <input id="description" placeholder="ìƒì„¸ ì„¤ëª…">
                            <input id="deposit" placeholder="ë³´ì¦ê¸ˆ">
                            <input id="imageHash" placeholder="Image IPFS Hash">
                        </div>
                        <div class="button-container">
                            <button onclick="registerAsset()">ì œí’ˆ ë“±ë¡</button>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <h3>ì œí’ˆ ì‚­ì œ</h3>
                    <div class="section-content">
                        <div class="input-group">
                            <input id="deleteAssetId" placeholder="ì‚­ì œí•  ìì‚° ID">
                        </div>
                        <div class="button-container">
                            <button class="danger" onclick="deleteAsset()">ì œí’ˆ ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ëŒ€ì—¬í•œ ì œí’ˆ íƒ­ -->
        <div class="tab-content" id="tab-my-rentals" style="display:none;">
            <div class="row">
                <div class="section">
                    <h3>ë‚´ê°€ ëŒ€ì—¬í•œ ìƒí’ˆ</h3>
                    <div class="section-content">
                        <div class="button-container">
                            <button onclick="listMyRentals()">ë‚´ ëŒ€ì—¬ ëª©ë¡</button>
                        </div>
                        <div class="card-list" id="myRentalList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ëŒ€ì—¬ ì™„ë£Œ íƒ­ -->
        <div class="tab-content" id="tab-complete" style="display:none;">
            <div class="row">
                <div class="section">
                    <h3>ëŒ€ì—¬ ì™„ë£Œ</h3>
                    <div class="section-content">
                        <div class="input-group">
                            <input id="completeContractId" placeholder="ê³„ì•½ ID">
                        </div>
                        <div class="button-container">
                            <button onclick="completeRental()">ëŒ€ì—¬ ì™„ë£Œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- í›„ê¸° ì‘ì„±/í™•ì¸ íƒ­ -->
        <div class="tab-content" id="tab-review" style="display:none;">
            <div class="row row-2col">
                <div class="section">
                    <h3>í›„ê¸° ì‘ì„±</h3>
                    <div class="section-content">
                        <div class="input-group">
                            <input id="reviewContractId" placeholder="ê³„ì•½ ID">
                            <input id="reviewee" placeholder="ìƒëŒ€ ì§€ê°‘ ì£¼ì†Œ">
                            <input id="score" placeholder="ì ìˆ˜ (1~5)">
                            <input id="comment" placeholder="í›„ê¸° ë‚´ìš©">
                            <input id="assetConditionHash" placeholder="ìì‚° ìƒíƒœ í•´ì‹œ">
                        </div>
                        <div class="button-container">
                            <button onclick="leaveReview()">í›„ê¸° ë‚¨ê¸°ê¸°</button>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <h3>í›„ê¸° í™•ì¸</h3>
                    <div class="section-content">
                        <div class="input-group">
                            <input id="reviewLookupId" placeholder="ê³„ì•½ ID">
                        </div>
                        <div class="button-container">
                            <button onclick="loadReviews()">ë¦¬ë·° ì¡°íšŒ</button>
                        </div>
                        <pre id="reviewResults"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const contractAddress = "0x24f41320C9472BF645C3515eD877aa15A0A00B9d";
        const contractABI = [
        {
            "inputs": [],
            "stateMutability": "nonpayable",
            "type": "constructor"
        },
        {
            "inputs": [],
            "name": "admin",
            "outputs": [
                {
                    "internalType": "address",
                    "name": "",
                    "type": "address"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "assetCount",
            "outputs": [
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }
            ],
            "name": "assets",
            "outputs": [
                {
                    "internalType": "uint256",
                    "name": "id",
                    "type": "uint256"
                },
                {
                    "internalType": "address",
                    "name": "owner",
                    "type": "address"
                },
                {
                    "internalType": "string",
                    "name": "category",
                    "type": "string"
                },
                {
                    "internalType": "string",
                    "name": "description",
                    "type": "string"
                },
                {
                    "internalType": "uint256",
                    "name": "deposit",
                    "type": "uint256"
                },
                {
                    "internalType": "bool",
                    "name": "isAvailable",
                    "type": "bool"
                },
                {
                    "internalType": "string",
                    "name": "imageHash",
                    "type": "string"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "contractId",
                    "type": "uint256"
                }
            ],
            "name": "completeRental",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "contractCount",
            "outputs": [
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "assetId",
                    "type": "uint256"
                },
                {
                    "internalType": "uint256",
                    "name": "startDate",
                    "type": "uint256"
                },
                {
                    "internalType": "uint256",
                    "name": "endDate",
                    "type": "uint256"
                }
            ],
            "name": "createRentalContract",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "assetId",
                    "type": "uint256"
                }
            ],
            "name": "deleteAsset",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "contractId",
                    "type": "uint256"
                }
            ],
            "name": "getReviewCount",
            "outputs": [
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "contractId",
                    "type": "uint256"
                },
                {
                    "internalType": "address",
                    "name": "reviewee",
                    "type": "address"
                },
                {
                    "internalType": "uint256",
                    "name": "score",
                    "type": "uint256"
                },
                {
                    "internalType": "string",
                    "name": "comment",
                    "type": "string"
                },
                {
                    "internalType": "string",
                    "name": "assetConditionHash",
                    "type": "string"
                }
            ],
            "name": "leaveReview",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "string",
                    "name": "category",
                    "type": "string"
                },
                {
                    "internalType": "string",
                    "name": "description",
                    "type": "string"
                },
                {
                    "internalType": "uint256",
                    "name": "deposit",
                    "type": "uint256"
                },
                {
                    "internalType": "string",
                    "name": "imageHash",
                    "type": "string"
                }
            ],
            "name": "registerAsset",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "registerUser",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }
            ],
            "name": "rentalContracts",
            "outputs": [
                {
                    "internalType": "uint256",
                    "name": "id",
                    "type": "uint256"
                },
                {
                    "internalType": "uint256",
                    "name": "assetId",
                    "type": "uint256"
                },
                {
                    "internalType": "address",
                    "name": "lender",
                    "type": "address"
                },
                {
                    "internalType": "address",
                    "name": "renter",
                    "type": "address"
                },
                {
                    "internalType": "uint256",
                    "name": "startDate",
                    "type": "uint256"
                },
                {
                    "internalType": "uint256",
                    "name": "endDate",
                    "type": "uint256"
                },
                {
                    "internalType": "uint256",
                    "name": "deposit",
                    "type": "uint256"
                },
                {
                    "internalType": "enum RentalPlatform.RentalStatus",
                    "name": "status",
                    "type": "uint8"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                },
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }
            ],
            "name": "reviewsByContract",
            "outputs": [
                {
                    "internalType": "uint256",
                    "name": "contractId",
                    "type": "uint256"
                },
                {
                    "internalType": "address",
                    "name": "reviewer",
                    "type": "address"
                },
                {
                    "internalType": "address",
                    "name": "reviewee",
                    "type": "address"
                },
                {
                    "internalType": "uint256",
                    "name": "score",
                    "type": "uint256"
                },
                {
                    "internalType": "string",
                    "name": "comment",
                    "type": "string"
                },
                {
                    "internalType": "string",
                    "name": "assetConditionHash",
                    "type": "string"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "address",
                    "name": "",
                    "type": "address"
                }
            ],
            "name": "userProfiles",
            "outputs": [
                {
                    "internalType": "uint256",
                    "name": "trustScore",
                    "type": "uint256"
                },
                {
                    "internalType": "uint256",
                    "name": "totalDeals",
                    "type": "uint256"
                },
                {
                    "internalType": "uint256",
                    "name": "averageRating",
                    "type": "uint256"
                },
                {
                    "internalType": "bool",
                    "name": "isRegistered",
                    "type": "bool"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        }
    ]

        let web3;
        let contract;
        let currentAccount;

        // ê³„ì • ì£¼ì†Œ í‘œì‹œ í•¨ìˆ˜
        function updateCurrentAccountDisplay() {
            const el = document.getElementById('currentAccountDisplay');
            if (window.currentAccount) {
                el.textContent = `í˜„ì¬ ê³„ì •: ${window.currentAccount}`;
            } else {
                el.textContent = 'í˜„ì¬ ê³„ì •: (ì—°ê²°ë˜ì§€ ì•ŠìŒ)';
            }
        }

        window.addEventListener("load", async () => {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: "eth_requestAccounts" });
                const accounts = await web3.eth.getAccounts();
                currentAccount = accounts[0];
                contract = new web3.eth.Contract(contractABI, contractAddress);
                window.currentAccount = currentAccount;
                updateCurrentAccountDisplay();
            } else {
                alert("MetaMaskê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        });

        async function switchAccount() {
            const accounts = await web3.eth.getAccounts();
            currentAccount = accounts[0];
            window.currentAccount = currentAccount;
            updateCurrentAccountDisplay();
            alert("í˜„ì¬ ê³„ì • ì „í™˜ë¨: " + currentAccount);
        }

        async function registerUser() {
            await contract.methods.registerUser().send({ from: currentAccount });
            alert("íšŒì› ë“±ë¡ ì™„ë£Œ");
        }

        async function registerAsset() {
            const depositEth = deposit.value;
            const depositWei = web3.utils.toWei(depositEth, "ether");

            await contract.methods.registerAsset(
                category.value || "ì¹´í…Œê³ ë¦¬ ì—†ìŒ",
                description.value || "ì„¤ëª… ì—†ìŒ",
                depositWei,
                imageHash.value || ""
            ).send({ from: currentAccount });

            alert("ì œí’ˆ ë“±ë¡ ì™„ë£Œ");

            // ğŸ”„ ë“±ë¡ í›„ ë‹¤ì‹œ ëª©ë¡ ê°±ì‹ 
            await listAssets();
        }


        async function listMyRentals() {
            try {
                const total = await contract.methods.contractCount().call();
                let html = '<div class="card-list">';
                for (let i = 1; i <= total; i++) {
                    const rc = await contract.methods.rentalContracts(i).call();
                    if (rc.renter.toLowerCase() === currentAccount.toLowerCase()) {
                        const asset = await contract.methods.assets(rc.assetId).call();

                        const start = new Date(rc.startDate * 1000).toLocaleDateString();
                        const end = new Date(rc.endDate * 1000).toLocaleDateString();

                        // âœ… ë³´ì¦ê¸ˆ ë‹¨ìœ„ ë³€í™˜ (Wei â†’ ETH)
                        const depositEth = web3.utils.fromWei(asset.deposit.toString(), "ether");

                        html += `
                        <div class="card">
                            <div class="card-id">ê³„ì•½ #${rc.id}</div>
                            <div class="card-title">${asset.category ? asset.category : 'ì¹´í…Œê³ ë¦¬ ì—†ìŒ'}</div>
                            <div class="card-desc">${asset.description ? asset.description : 'ì„¤ëª… ì—†ìŒ'}</div>
                            <div class="card-price">ê¸°ê°„: ${start} ~ ${end}</div>
                            <div class="card-price">ë³´ì¦ê¸ˆ: ${depositEth} ETH</div>
                            <div class="${asset.isAvailable ? 'card-available' : 'card-unavailable'}">
                                ${asset.isAvailable ? 'ëŒ€ì—¬ ê°€ëŠ¥' : 'ëŒ€ì—¬ ë¶ˆê°€'}
                            </div>
                            <div class="card-owner">ë“±ë¡ì: ${asset.owner}</div>
                        </div>
                        `;
                    }
                }
                html += '</div>';
                if (html === '<div class="card-list"></div>') {
                    html = '<div style="text-align:center;color:#aaa;padding:30px 0;">ë‚´ê°€ ëŒ€ì—¬í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                document.getElementById("myRentalList").innerHTML = html;
            } catch (err) {
                console.error(err);
                alert("ëŒ€ì—¬ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            }
        }

        async function listAssets() {
            const count = await contract.methods.assetCount().call();
            let html = '<div class="card-list">';
            for (let i = 1; i <= count; i++) {
                const asset = await contract.methods.assets(i).call();

                // ğŸ§¹ ì‚­ì œëœ ìì‚°ì€ ìŠ¤í‚µ
                if (asset.owner === "0x0000000000000000000000000000000000000000") continue;

                const formattedDeposit = web3.utils.fromWei(asset.deposit.toString(), "ether");

                html += `
                <div class="card">
                    <div class="card-id" style="position:absolute; top:12px; right:18px; color:#bbb;">ìƒí’ˆ ë²ˆí˜¸ #${asset.id}</div>
                    <div class="card-title" style="color:#357abd; font-weight:700;">${asset.category || 'ì¹´í…Œê³ ë¦¬ ì—†ìŒ'}</div>
                    <div class="card-desc">${asset.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                    <div class="card-price">ë³´ì¦ê¸ˆ: ${formattedDeposit} ETH</div>
                    <div class="${asset.isAvailable ? 'card-available' : 'card-unavailable'}">
                        ${asset.isAvailable ? 'ëŒ€ì—¬ ê°€ëŠ¥' : 'ëŒ€ì—¬ ë¶ˆê°€'}
                    </div>
                    <div class="card-owner">ë“±ë¡ì: ${asset.owner}</div>
                </div>
                `;
            }

            if (html === '<div class="card-list">') {
                html = '<div style="text-align:center;color:#aaa;padding:30px 0;">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                html += '</div>';
            }

            document.getElementById("assetList").innerHTML = html;
        }


        function toTimestamp(dateStr) {
            const date = new Date(dateStr + "T00:00:00Z"); // UTC ê¸°ì¤€ìœ¼ë¡œ ê³ ì •
            return Math.floor(date.getTime() / 1000);
        }

        async function createRentalContract() {
            try {
                const start = toTimestamp(document.getElementById("startDateInput").value);
                const end = toTimestamp(document.getElementById("endDateInput").value);
                const asset = await contract.methods.assets(rentalAssetId.value).call();

                const depositWei = BigInt(asset.deposit);
                const totalPayment = depositWei;
                await contract.methods.createRentalContract(
                    rentalAssetId.value, start, end
                ).send({ from: currentAccount, value: totalPayment.toString() });

                alert("ëŒ€ì—¬ ìš”ì²­ ì™„ë£Œ");
            } catch (error) {
                console.error("ì‹¤íŒ¨: ", error);
                alert("ì‹¤íŒ¨ ì›ì¸:\n" + (error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì‹¤íŒ¨"));
            }
        }

        async function deleteAsset() {
            const id = document.getElementById("deleteAssetId").value;
            try {
                await contract.methods.deleteAsset(id).send({ from: currentAccount });
                alert("ì œí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                await listAssets(); // âœ… ì‚­ì œ í›„ ì¹´ë“œ ê°±ì‹ 
            } catch (err) {
                console.error("ì‚­ì œ ì‹¤íŒ¨:", err);
                alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
            }
        }


        async function completeRental() {
            try {
                const contractId = completeContractId.value;
                const rc = await contract.methods.rentalContracts(contractId).call();
                console.log("ê³„ì•½ ìƒíƒœ:", rc.status);
                console.log("ë Œë” ì£¼ì†Œ:", rc.lender);
                console.log("ë‚´ ì£¼ì†Œ:", currentAccount);

                await contract.methods.completeRental(contractId).send({ from: currentAccount });
                alert("ëŒ€ì—¬ ì™„ë£Œ ì²˜ë¦¬ë¨");
            } catch (error) {
                console.error("ëŒ€ì—¬ ì™„ë£Œ ì‹¤íŒ¨:", error);
                alert("ëŒ€ì—¬ ì™„ë£Œ ì‹¤íŒ¨:\n" + error.message);
            }
        }

        async function leaveReview() {
            await contract.methods.leaveReview(
                reviewContractId.value, reviewee.value,
                score.value, comment.value, assetConditionHash.value
            ).send({ from: currentAccount });
            alert("í›„ê¸° ì‘ì„± ì™„ë£Œ");
        }

        async function loadReviews() {
            const contractId = reviewLookupId.value;

            try {
                const reviewCount = await contract.methods.getReviewCount(contractId).call();
                if (reviewCount == 0) {
                    reviewResults.innerHTML = "<div style='text-align:center; padding:20px; color:#aaa;'>ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                    return;
                }

                let html = '<div class="card-list">';
                for (let i = 0; i < reviewCount; i++) {
                    const review = await contract.methods.reviewsByContract(contractId, i).call();
                    html += `
                        <div class="card">
                            <div class="card-id">ê³„ì•½ ID #${review.contractId}</div>
                            <div class="card-title">ì ìˆ˜: ${review.score}ì </div>
                            <div class="card-desc">"${review.comment}"</div>
                            <div class="card-owner">ì‘ì„±ì: ${review.reviewer}</div>
                            <div class="card-owner">ëŒ€ìƒì: ${review.reviewee}</div>
                            <div class="card-category">ìì‚° ìƒíƒœ í•´ì‹œ: ${review.assetConditionHash}</div>
                        </div>
                    `;
                }
                html += '</div>';

                reviewResults.innerHTML = html;

            } catch (e) {
                console.error("ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:", e);
                reviewResults.innerHTML = `<div style='color:red;'>ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
            }
        }


        // íƒ­ ì „í™˜ ìŠ¤í¬ë¦½íŠ¸
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-btn[onclick*="' + tabId + '"]').classList.add('active');
        }
    </script>
</body>
</html>
